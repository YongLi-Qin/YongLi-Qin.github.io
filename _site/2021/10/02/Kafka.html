<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="ğŸ“•ã€Toolã€‘Kafka basic idea" />
<meta name="author" content="QYF" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Note for Kafka videos by confluent, which provides great help. [Link][https://www.youtube.com/watch?v=jY02MB-sz8I&amp;list=RDCMUCmZz-Gj3caLLzEWBtbYUXaA&amp;index=3]" />
<meta property="og:description" content="Note for Kafka videos by confluent, which provides great help. [Link][https://www.youtube.com/watch?v=jY02MB-sz8I&amp;list=RDCMUCmZz-Gj3caLLzEWBtbYUXaA&amp;index=3]" />
<link rel="canonical" href="http://localhost:4000/2021/10/02/Kafka.html" />
<meta property="og:url" content="http://localhost:4000/2021/10/02/Kafka.html" />
<meta property="og:site_name" content="Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-02T00:00:00+10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ğŸ“•ã€Toolã€‘Kafka basic idea" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2021/10/02/Kafka.html","headline":"ğŸ“•ã€Toolã€‘Kafka basic idea","datePublished":"2021-10-02T00:00:00+10:00","dateModified":"2023-02-18T15:24:08+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/10/02/Kafka.html"},"author":{"@type":"Person","name":"QYF"},"description":"Note for Kafka videos by confluent, which provides great help. [Link][https://www.youtube.com/watch?v=jY02MB-sz8I&amp;list=RDCMUCmZz-Gj3caLLzEWBtbYUXaA&amp;index=3]","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css" />
  <link rel="shortcut icon" type="image/x-icon" href="/./favicon.ico?" />
  <link rel="stylesheet" href="http://localhost:4000/assets/css/agate.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Blog" /></head><body>
    <main class="page-content" aria-label="Content">
        <div class="wrapper">
            <article
  class="post h-entry"
  itemscope
  itemtype="http://schema.org/BlogPosting"
>
  <head>
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <title>ğŸ“•ã€Toolã€‘Kafka basic idea</title>
  </head>
  <header class="post-header">
    <div class="post-back">
      <a class="black-link" href="http://localhost:4000">
        â† Index
      </a>
    </div>

    <h1 class="post-title p-name" itemprop="name headline">
      ğŸ“•ã€Toolã€‘Kafka basic idea
    </h1>
    <p class="post-meta">
      <time
        class="dt-published"
        datetime="2021-10-02T00:00:00+10:00"
        itemprop="datePublished"
      >Oct 2, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Note for Kafka videos by confluent, which provides great help.
[Link][https://www.youtube.com/watch?v=jY02MB-sz8I&amp;list=RDCMUCmZz-Gj3caLLzEWBtbYUXaA&amp;index=3]</p>

<h2 id="ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶">ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶ï¼Ÿ</h2>

<p>äº‹ä»¶é©±åŠ¨çš„ç¨‹åºè¶Šæ¥è¶Šå¤šï¼Œä»ä»¥å‰çš„é™æ€åˆ°å¦‚ä»Šä¸æ–­çš„äº‹ä»¶æµï¼Œå¯¹äºä¸€ä¸ªç¨‹åºéœ€è¦å¤„ç†çš„äº‹æƒ…æ›´åŠ å¤šäº†ï¼Œæ›´è¿½æ±‚å®æ—¶æ€§ï¼Œéœ€è¦ä¸€ä¸ªä¸­é—´ä»¶æœ‰ä¸€ä¸‹ç‰¹ç‚¹</p>

<ol>
  <li>Single platform to connect every one to every event</li>
  <li>Real-time stream of events</li>
  <li>All events stored fro historical view</li>
</ol>

<h2 id="element">Element</h2>

<p><strong>Producers</strong>: The application which generate data and push(write) into the kafka cluster
<strong>Kafka cluster</strong>: The place store data, it contains many brokers
<strong>Consumers</strong>: The applicatin which poll(read) data from the Kafka cluster
<strong>Zookeeper</strong>: Used for cluster management, failure detection &amp; recovery, basically all the distrubuted stuff.</p>

<p><em>Producers and consumers are total decoupling.</em></p>

<p><img src="https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/%E6%88%AA%E5%B1%8F2021-10-01%20%E4%B8%8B%E5%8D%885.49.32.png" alt="Kafka Element" /></p>

<p><strong>Topic</strong>: Itâ€™s like categories used to organize message. Producers write to topic and consumer read from topic. Topic å°±æ˜¯æ•°æ®ä¸»é¢˜ï¼Œæ˜¯æ•°æ®è®°å½•å‘å¸ƒçš„åœ°æ–¹,å¯ä»¥ç”¨æ¥åŒºåˆ†ä¸šåŠ¡ç³»ç»Ÿã€‚<a href="https://kafka.apachecn.org/intro.html">Linkd</a>
<strong>Partition</strong>: Topic are partitioned across multiple nodes physically, and the node here is partition, each node is in different broker.
<strong>Broker</strong>:</p>

<ol>
  <li>Broken handles many partitions</li>
  <li>Partition stored on Brokerâ€™s disk</li>
  <li>Partition is log file, append only</li>
  <li>Broker replication: for a partition in broker A, that it would have a copy of it in other broker. So there would be a leader partition and a follower partition. Follower partition need to make sure update from the leader partition as quickly as possible.</li>
</ol>

<p><em>Why we need partition?</em></p>

<ol>
  <li>Scalable</li>
  <li>Replication</li>
</ol>

<p><em>How do we know which partition the message go to when writing as a producer?</em></p>

<ol>
  <li>Depends on Kafka, Kafka use round robin method to decide which partition the message go to.</li>
  <li>When writing a message, passing a key to Kafka, Kafka would use <code class="highlighter-rouge">hash(key) % number_of_partitions</code> to decide which partition to write into.</li>
  <li>Customise by user</li>
</ol>

<p><em>When we need to method 2 above?</em>
When the user want some kind of message with ordered, and the order of event is important, then just give those message a same key. By using method 2, all those data would go to one partition. And In the partition, it could make sure that those message is ordered by writing time.</p>

<h2 id="how-kafka-works">How Kafka works</h2>

<h4 id="partition-leadership--replication"><strong>Partition leadership &amp; Replication</strong></h4>

<p>The producers and customers are always â€˜<em>communicate</em>â€™ with the leader of each partition</p>

<p>If one of the broker dies, for example broker 4, a new leader for partition 4 would be elected right away, can continue the writing and reading for this partition</p>

<p><img src="https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Partition-Leadership.png" alt="Partition Leader &amp; Replication" /></p>

<h4 id="data-retention-policy"><strong>Data retention policy</strong></h4>

<p>The duration a partition store the data is configuable, by default it would be kept for a week. 
When the newest message in the segment is older than the retention period, then it would be a expired segment and deleted in the partition.</p>

<h4 id="producer-design"><strong>Producer Design</strong></h4>

<p><img src="https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Producer-Design.png" alt="Produce-Design" /></p>

<p>For each producer record, it would be serialised first and then the partitioner would decide which partition this message should go to.</p>

<p>If the key in the record, then it would use round-robin to decide what to go defaultly, otherwise use function <code class="highlighter-rouge">hash(key) % number_of_partitions</code>  to decide which partition to put in the message</p>

<h4 id="producer-guarantees"><a name="ProducerGuarantees"><strong>Producer Guarantees</strong></a></h4>

<p><img src="https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/producer-guarantees.png" alt="Producer-Guarantees" /></p>

<p>There is three types of level to guarantees the writing of the message</p>

<ol>
  <li>
    <p>Do not wait any ACK for any broker, just send the message and then send the next one directly.</p>

    <p>Data Losing: â­ï¸â­ï¸â­ï¸â­ï¸
Latency: â­ï¸</p>
  </li>
  <li>
    <p>Wait the ACK from the leader, the leader would send the ACK after it writing the message into the disk</p>

    <p>Data Losing: â­ï¸â­ï¸
Latency: â­ï¸â­ï¸â­ï¸</p>
  </li>
  <li>
    <p>Wait the ACK from the leader and the all followers</p>

    <p>Data Losing: â­ï¸
Latency: â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</p>
  </li>
</ol>

<h4 id="customer-rebalances"><strong>Customer Rebalances</strong></h4>

<p><img src="https://typora-1302119905.cos.ap-nanjing.myqcloud.com/Coding/Customer-Rebalance.png" alt="Customer-Rebalances" /></p>

<h4 id="compacted-topics"><strong>Compacted Topics</strong></h4>

<p>When the consumer only want to know the lastest log message for a key(It measn for each message, it need to have a kep). The log only keep the newest value of a key</p>

<p>Compacted topic é€‚ç”¨äºå½“æ¶ˆè´¹è€…åªå…³æ³¨æ¯ä¸ªkeyæœ€æ–°çš„é‚£ä¸ªæ¶ˆæ¯ï¼Œå…¶ä»–ä¹‹å‰çš„æ¶ˆæ¯å¹¶ä¸å…³å¿ƒæ—¶ï¼Œä½¿ç”¨compacted topicåï¼ŒKafkaä¼šå®šæœŸå°†é‡å¤keyçš„â€˜æ—§â€™æ¶ˆæ¯åˆ é™¤ï¼Œå¹¶ä¸”æ¶ˆè´¹æ—¶æä¾›æœ€æ–°çš„æ¶ˆæ¯</p>

<h2 id="ç”Ÿäº§ç«¯producer">ç”Ÿäº§ç«¯(Producer)</h2>

<ol>
  <li><a href="#ProducerGuarantees">åº”ç­”æœºåˆ¶</a>
åº”ç­”æœºåˆ¶æœ‰ä¸‰ç§è®¾ç½®ï¼Œå„æœ‰åˆ©å¼Šï¼Œè¯¦æƒ…çœ‹é“¾æ¥</li>
  <li><a href="#æ•°æ®ä¸¢å¤±ä¸æ•°æ®é‡å¤ (Message Delivery)">æ•°æ®ä¸¢å¤±ä¸æ•°æ®é‡å¤</a></li>
  <li>
    <p><a href="#å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿(Idempotence message sending)">å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿</a></p>
  </li>
  <li>Never send duplicate message, but maybe missing -&gt; At most one</li>
  <li>Never miss any message, but maybe duplicate -&gt; At least one</li>
  <li>Never miss and duplicate -&gt; Exactly one</li>
</ol>

<p><em>Why we need exactly one?</em></p>

<p>å¯¹äºä¸€äº›äº¤æ˜“ç³»ç»Ÿæ¥è¯´ï¼Œå¤šä¸€æ¬¡æ¶ˆè´¹æˆ–è€…å°‘ä¸€æ¬¡æ¶ˆè´¹éƒ½æ˜¯ä¸è¢«å…è®¸çš„ï¼Œè¿™æ—¶å€™ä¿è¯Exactly Oneå°±ååˆ†é‡è¦
For some system like trading system, duplicate trading message or missing trading message is not allowed, to gurantee exactly one is needed.</p>

<p><em>How to achieve <strong>At most one</strong> or <strong>At least one</strong>?</em></p>

<p>å°†åº”ç­”æœºåˆ¶ä¸­çš„ACKé…ç½®è®¾ç½®ä¸º0ï¼ŒKafkaè¿™æ—¶å€™å°±æ˜¯<strong>At most one</strong>çŠ¶æ€
å°†åº”ç­”æœºåˆ¶ä¸­çš„ACKé…ç½®è®¾ç½®ä¸º-1ï¼ŒKafkaè¿™æ—¶å€™æ˜¯<strong>At lease one</strong>çŠ¶æ€</p>

<p><em>How to achieve <strong>Exactly One</strong> as producer sending messageï¼Ÿ</em></p>

<p>At least one + å¹‚ç­‰ == Exactly One.  ä¸ºäº†ä¿è¯æ¶ˆæ¯ä¸é‡å¤è¢«å†™å…¥åº“ï¼ŒKafkaåœ¨producerç«¯å¼•å…¥äº†å¹‚ç­‰å¤„ç†ã€‚<a href="https://zh.wikipedia.org/wiki/%E5%86%AA%E7%AD%89">ä»€ä¹ˆæ˜¯å¹‚ç­‰å¤„ç†ï¼Ÿ</a>
å¯¹äºæ¯ä¸ªProducerï¼Œåˆå§‹åŒ–æ—¶å€™èµ‹äºˆPIDï¼Œå¯¹äºå‘é€çš„æ¯ä¸ªæ¶ˆæ¯&lt;Topic, Patition&gt;éƒ½æœ‰ä¸€ä¸ªä»0å¼€å§‹çš„Sequence numberã€‚
åœ¨Brokeç«¯ï¼Œå¯¹äºæ¯ä¸ª&lt;PID, Topic, Partition&gt;éƒ½ç»´æŠ¤ä¸€ä¸ªåºåˆ—å·ï¼Œæ²¡æ”¶åˆ°ä¸€æ¬¡æ¶ˆæ¯è¯¥åºåˆ—å·+1ï¼Œæ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦æ ¡éªŒåºåˆ—å·æ˜¯å¦æ»¡è¶³è¯¥&lt;PID, Topic, Partition&gt;çš„æœ€å¤§åºåˆ—å·+1ï¼Œå¦‚æœä¸æ»¡è¶³ä¸æ¥å—è¯¥æ¶ˆæ¯</p>

<ol>
  <li>å¤§äºæœ€å¤§åºåˆ—å· + 1ï¼Œåˆ™è®¤ä¸ºæœ‰æ•°æ®è¿˜æ²¡å†™å…¥æˆ–è€…åœ¨ä¼ è¾“è·¯ä¸Šï¼Œè¯¥æ•°æ®ä¸ä¼šè¢«é‡‡çº³ï¼ŒæŠ›å‡ºInvalidSequenceNumber</li>
  <li>å°äºæœ€å¤§åºåˆ—å· + 1ï¼Œåˆ™è®¤ä¸ºè¯¥æ•°æ®æ˜¯é‡å¤æ•°æ®ï¼ŒåŒæ ·ä¸è¢«é‡‡çº³ï¼ŒæŠ›å‡ºDuplicateSequenceNumberå¼‚å¸¸</li>
</ol>

<h4 id="å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿idempotence-message-sending">å¹‚ç­‰å‘é€è®¾è®¡çš„ä¼˜åŠ¿(Idempotence message sending)</h4>

<ol>
  <li>ä¿è¯æ¯ä¸ªpartitionä¸­çš„æ¶ˆæ¯æ˜¯æŒ‰é¡ºåºçš„ï¼Œå› ä¸ºä¸æŒ‰é¡ºåºä¼šè¢«æ‹’ç»å†™å…¥ç£ç›˜</li>
  <li>ä¿è¯æ¯ä¸ªæ¶ˆæ¯ä¸ä¼šé‡å¤è¢«å†™å…¥ç£ç›˜å¯¼è‡´é‡å¤æ¶ˆè´¹</li>
</ol>

<p>æ³¨æ„ï¼Œåœ¨ProduceråŠ å…¥äº†å¹‚ç­‰æ€§å‘é€çš„é…ç½®åï¼Œä»…ä»…èƒ½ä¿è¯å•ä¸ªProduceråœ¨åŒä¸€ä¸ªSessionä¸­å•Topicå•ä¸ªåˆ†åŒºç”Ÿäº§çš„æ•°æ®Exactly Oneï¼Œ</p>


  </div>

  <a class="u-url" href="/2021/10/02/Kafka.html" hidden></a>
</article>

<div class="ant-alert mb-0">
  <ul>
    <li>Posted at 2021-10-02ï¼ŒUpdated at 2023-02-18
    </li>
  </ul>

</div>

<div class="page-navigation">
  
  <a class="prev" href="/2021/09/20/MySQL's-Index.html">&laquo; Prev</a>
   
  <a class="next" href="/2022/07/27/Command.html">Next &raquo;</a>
  
</div><script src="https://giscus.app/client.js" data-repo="HarryQin99/HarryQin99.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk0MDc4ODgxMzk=" data-category="General" data-category-id="DIC_kwDOGE_hC84CVdSA"
        data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0"
        data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" crossorigin="anonymous" async>
        </script>
        </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/"></data>
    <div class="wrapper">
      <div class="footer-col-wrapper">
        <div class="footer-col">
          <ul class="contact-list">
            <li class="p-name"><a class="black-link" href="http://localhost:4000/about.html">
                  QYF 
                </a></li><li>
              <a class="u-email black-link" href="mailto:harryqinyf@outlook.com">harryqinyf@outlook.com</a></li></ul>
        </div>
      </div>
    </div>
  </footer></body>
</html>